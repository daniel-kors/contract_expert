{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <h2 class="mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–∏–∏ –∏–∑–≤–µ—â–µ–Ω–∏—è -->
        {% if not result.has_notice %}
        <div class="alert alert-info mb-4">
            <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≤–µ–¥–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É. –î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–≤–µ—â–µ–Ω–∏–µ –æ –∑–∞–∫—É–ø–∫–µ.
        </div>
        {% endif %}

        <!-- –°–≤–æ–¥–∫–∞ -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">–°–≤–æ–¥–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</h5>
            </div>
            <div class="card-body">
                {% if result.summary %}
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <h3>{{ result.summary.total_issues }}</h3>
                            <p class="text-muted">–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <h3 class="text-danger">{{ result.summary.critical_issues }}</h3>
                            <p class="text-muted">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <h3>{{ result.summary.recommendations|length }}</h3>
                            <p class="text-muted">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</p>
                        </div>
                        <div class="col-md-3 text-center">
                            {% if result.summary.status == 'high_risk' %}
                                <span class="badge bg-danger fs-6">–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫</span>
                            {% elif result.summary.status == 'medium_risk' %}
                                <span class="badge bg-warning fs-6">–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫</span>
                            {% else %}
                                <span class="badge bg-success fs-6">–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if result.timestamp %}
                    <div class="mt-3 text-end">
                        <small class="text-muted">–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω: {{ result.timestamp }}</small>
                    </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted">–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã</p>
                {% endif %}
            </div>
        </div>

        <!-- –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ -->
        {% if result.basic_analysis %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π</h5>
            </div>
            <div class="card-body">
                {% if result.basic_analysis.errors %}
                    <div class="alert alert-danger">
                        <h6>–ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏:</h6>
                        <ul class="mb-0">
                            {% for error in result.basic_analysis.errors %}
                                <li class="issue-critical p-2">
                                    <strong>{{ error.message }}</strong>
                                    {% if error.severity == 'critical' %}
                                        <span class="badge bg-danger ms-2">–ö—Ä–∏—Ç–∏—á–Ω–æ</span>
                                    {% endif %}
                                    {% if error.get('found_alternative') %}
                                        <br><small class="text-muted">–ù–∞–π–¥–µ–Ω—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏</small>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <div class="alert alert-success">
                        ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                    </div>
                {% endif %}

                {% if result.basic_analysis.warnings %}
                    <div class="alert alert-warning">
                        <h6>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</h6>
                        <ul class="mb-0">
                            {% for warning in result.basic_analysis.warnings %}
                                <li class="issue-warning p-2">
                                    {{ warning.message }}
                                    {% if warning.get('details') %}
                                        <br><small class="text-muted">{{ warning.details }}</small>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö -->
                {% if result.basic_analysis.mandatory_clauses_checked %}
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:</strong>
                        {{ result.basic_analysis.mandatory_clauses_checked|join(', ') }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∏–∑–≤–µ—â–µ–Ω–∏–µ–º -->
        {% if result.has_notice and result.comparison %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∏–∑–≤–µ—â–µ–Ω–∏–µ–º –æ –∑–∞–∫—É–ø–∫–µ</h5>
            </div>
            <div class="card-body">
                {% if result.comparison.mismatches %}
                    <div class="alert alert-warning">
                        <h6>–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è:</h6>
                        <ul class="mb-0">
                            {% for mismatch in result.comparison.mismatches %}
                                <li class="issue-warning p-2">
                                    <strong>{{ mismatch.message }}</strong>
                                    {% if mismatch.contract_value and mismatch.notice_value %}
                                        <br>
                                        <small>
                                            –í –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ: {{ mismatch.contract_value }} |
                                            –í –∏–∑–≤–µ—â–µ–Ω–∏–∏: {{ mismatch.notice_value }}
                                        </small>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <div class="alert alert-success">
                        ‚úÖ –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–∑–≤–µ—â–µ–Ω–∏—é –æ –∑–∞–∫—É–ø–∫–µ
                    </div>
                {% endif %}

                {% if result.comparison.parameters_compared %}
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong>
                        {{ result.comparison.parameters_compared|join(', ') }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- AI –∞–Ω–∞–ª–∏–∑ -->
        {% if result.ai_analysis %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">AI –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</h5>
            </div>
            <div class="card-body">
                {% if result.ai_analysis.issues %}
                    {% for issue in result.ai_analysis.issues %}
                        <div class="alert
                            {% if issue.severity == 'critical' %}alert-danger issue-critical
                            {% elif issue.severity == 'warning' %}alert-warning issue-warning
                            {% else %}alert-info issue-info{% endif %} p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong>{{ issue.description }}</strong>
                                    <br>
                                    <small class="mt-1 d-block">
                                        <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> {{ issue.recommendation }}
                                    </small>
                                </div>
                                <span class="badge
                                    {% if issue.severity == 'critical' %}bg-danger
                                    {% elif issue.severity == 'warning' %}bg-warning
                                    {% else %}bg-info{% endif %} ms-2">
                                    {{ issue.severity }}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-success">
                        ‚úÖ AI –∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã—è–≤–∏–ª —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
                    </div>
                {% endif %}

                {% if result.ai_analysis.recommendations %}
                    <div class="alert alert-info">
                        <h6>üìã –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h6>
                        <ul class="mb-0">
                            {% for recommendation in result.ai_analysis.recommendations %}
                                <li class="mb-1">{{ recommendation }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if result.ai_analysis.summary %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6>üìä –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:</h6>
                        <p class="mb-0">{{ result.ai_analysis.summary }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ -->
        {% if result.contract_info %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if result.contract_info.price %}
                    <div class="col-md-6">
                        <strong>–¶–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:</strong> {{ result.contract_info.price }}
                    </div>
                    {% endif %}
                    {% if result.contract_info.supplier %}
                    <div class="col-md-6">
                        <strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong> {{ result.contract_info.supplier }}
                    </div>
                    {% endif %}
                    {% if result.contract_info.customer %}
                    <div class="col-md-6">
                        <strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> {{ result.contract_info.customer }}
                    </div>
                    {% endif %}
                    {% if result.contract_info.period %}
                    <div class="col-md-6">
                        <strong>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong> {{ result.contract_info.period }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="text-center mt-4">
            <a href="{{ url_for('upload_files') }}" class="btn btn-primary me-2">üîÑ –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</a>
            <a href="{{ url_for('chat') }}" class="btn btn-outline-primary me-2">üí¨ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</a>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>

        <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏) -->
        {% if config.DEBUG %}
        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0">–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
            </div>
            <div class="card-body">
                <details>
                    <summary>–ü–æ–∫–∞–∑–∞—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ</summary>
                    <pre class="mt-3"><code>{{ result|tojson(indent=2) }}</code></pre>
                </details>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}